#!/usr/bin/env zsh
#
# This script assumes a structure of a root directory with the clone repo and then worktrees in the project dir or some subdir

find_project_root() {
    local current_dir=$(pwd)
    local project_root=""

    while [[ "$current_dir" != "/" ]]; do 
        if [[ -d "$current_dir/worktrees" ]]; then 
            project_root="$current_dir"
            break
        fi
        current_dir=$(dirname "$current_dir")
    done

    if [[ -z "$project_root" ]]; then 
        project_root=$(pwd)
    fi 

    echo "$project_root"
} 

abbreviate_path() {
    local path="$1"
    local abbreviated_path=""
    local dirs=("${(@s:/:)path}")
    
    if [[ ${#dirs} -le 3 ]]; then
        abbreviated_path="$path"
    else
        abbreviated_path="${dirs[1]}/.../${dirs[-2]}/${dirs[-1]}"
    fi
    
    echo "$abbreviated_path"
}

project_root=$(find_project_root)
selected_dir=$(find "$project_root" -maxdepth 3 -type d | while read -r dir; do
    abbreviated_dir=$(abbreviate_path "$dir")
    echo "$dir | $abbreviated_dir"
done | fzf --with-nth 2.. --delimiter ' | ' --preview 'echo {}' --preview-window up:1)

if [[ -z "$selected_dir" ]]; then
    echo "No directory selected"
    exit 0
fi

selected_dir=$(echo "$selected_dir" | cut -d' ' -f1)
window_name=$(basename "$selected_dir" | tr . _)

if ! tmux list-windows -F '#{window_name}' | grep -q "^$window_name\$" 2> /dev/null ; then
    tmux new-window -n "$window_name" -c "$selected_dir"
fi

tmux select-window -t "$window_name"

# Below is a really interesting different script to preview the tree structure of projects
##!/usr/bin/env zsh
##
## This script assumes a structure of a root directory with the clone repo and then worktrees in the project dir or some subdir

#find_project_root() {
#    local current_dir=$(pwd)
#    local project_root=""

#    while [[ "$current_dir" != "/" ]]; do 
#        if [[ -d "$current_dir/worktrees" ]]; then 
#            project_root="$current_dir"
#            break
#        fi
#        current_dir=$(dirname "$current_dir")
#    done

#    if [[ -z "$project_root" ]]; then 
#        project_root=$(pwd)
#    fi 

#    echo "$project_root"
#} 

#project_root=$(find_project_root)
#selected_dir=$(tree -d -L 3 "$project_root" | fzf --preview 'tree -d {}' --preview-window=right:50%)

#if [[ -z "$selected_dir" ]]; then
#    echo "No directory selected"
#    exit 0
#fi

#window_name=$(basename "$selected_dir" | tr . _)

#if ! tmux list-windows -F '#{window_name}' | grep -q "^$window_name\$" 2> /dev/null ; then
#    tmux new-window -n "$window_name" -c "$selected_dir"
#fi

#tmux select-window -t "$window_name"
